// schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql" // ou "mysql", "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// CLIENTS
// ============================================

model Client {
  id                String    @id @default(cuid())
  nom               String
  prenom            String?
  entreprise        String?
  email             String    @unique
  telephone         String?
  adresse           String?
  code_postal       String?
  ville             String?
  pays              String    @default("France")
  siret             String?
  tva_intra         String?

  devis             Devis[]
  factures          Facture[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("clients")
}

// ============================================
// DEVIS
// ============================================

model Devis {
  id                String           @id @default(cuid())
  numero            String           @unique // Format: DEV-2025-001
  client_id         String
  client            Client           @relation(fields: [client_id], references: [id], onDelete: Cascade)

  objet             String
  type_tarification TypeTarification @default(MIXTE)

  date_creation     DateTime         @default(now())
  date_validite     DateTime
  date_signature    DateTime?

  statut            StatutDevis      @default(BROUILLON)

  // Signature électronique
  signe_par         String?
  signature_ip      String?
  signature_data    String?          @db.Text

  notes             String?          @db.Text
  conditions        String?          @db.Text

  // Montants
  montant_ht        Decimal          @default(0) @db.Decimal(10, 2)
  tva_taux          Decimal          @default(20) @db.Decimal(5, 2)
  tva_montant       Decimal          @default(0) @db.Decimal(10, 2)
  montant_ttc       Decimal          @default(0) @db.Decimal(10, 2)

  // Acompte
  acompte_requis    Boolean          @default(true)
  acompte_pourcentage Decimal        @default(30) @db.Decimal(5, 2)

  lignes            LigneDevis[]
  factures          Facture[]

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@map("devis")
}

model LigneDevis {
  id              String      @id @default(cuid())
  devis_id        String
  devis           Devis       @relation(fields: [devis_id], references: [id], onDelete: Cascade)

  ordre           Int         @default(0)

  type_ligne      TypeLigne
  description     String      @db.Text

  quantite        Decimal     @db.Decimal(10, 2)
  unite           String
  prix_unitaire   Decimal     @db.Decimal(10, 2)
  total_ht        Decimal     @db.Decimal(10, 2)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("lignes_devis")
}

// ============================================
// FACTURES
// ============================================

model Facture {
  id                String         @id @default(cuid())
  numero            String         @unique // Format: FF-345-536 ou FA-345-536

  client_id         String
  client            Client         @relation(fields: [client_id], references: [id], onDelete: Cascade)

  devis_id          String
  devis             Devis          @relation(fields: [devis_id], references: [id])

  type_facture      TypeFacture    @default(FINALE)

  objet             String

  date_emission     DateTime       @default(now())
  date_echeance     DateTime

  statut            StatutFacture  @default(EN_ATTENTE)

  notes             String?        @db.Text
  conditions        String?        @db.Text

  // Montants
  montant_ht        Decimal        @default(0) @db.Decimal(10, 2)
  tva_taux          Decimal        @default(20) @db.Decimal(5, 2)
  tva_montant       Decimal        @default(0) @db.Decimal(10, 2)
  montant_ttc       Decimal        @default(0) @db.Decimal(10, 2)

  montant_paye      Decimal        @default(0) @db.Decimal(10, 2)

  // Pour la facture finale : déduction de l'acompte
  acompte_deduit    Decimal?       @db.Decimal(10, 2)
  facture_acompte_id String?

  lignes            LigneFacture[]
  paiements         Paiement[]

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@map("factures")
}

model LigneFacture {
  id              String      @id @default(cuid())
  facture_id      String
  facture         Facture     @relation(fields: [facture_id], references: [id], onDelete: Cascade)

  ordre           Int         @default(0)

  type_ligne      TypeLigne
  description     String      @db.Text

  quantite        Decimal     @db.Decimal(10, 2)
  unite           String
  prix_unitaire   Decimal     @db.Decimal(10, 2)
  total_ht        Decimal     @db.Decimal(10, 2)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("lignes_facture")
}

// ============================================
// PAIEMENTS
// ============================================

model Paiement {
  id              String        @id @default(cuid())
  facture_id      String
  facture         Facture       @relation(fields: [facture_id], references: [id], onDelete: Cascade)

  date_paiement   DateTime      @default(now())
  montant         Decimal       @db.Decimal(10, 2)
  mode_paiement   ModePaiement  @default(VIREMENT) // Virement par défaut
  reference       String?
  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("paiements")
}

// ============================================
// PARAMETRES
// ============================================

model Parametres {
  id                    String   @id @default(cuid())

  nom_entreprise        String
  forme_juridique       String?
  siret                 String?
  tva_intra             String?

  adresse               String?
  code_postal           String?
  ville                 String?
  pays                  String   @default("France")

  email                 String
  telephone             String?
  site_web              String?

  tjm_defaut            Decimal? @db.Decimal(10, 2)
  tva_taux_defaut       Decimal  @default(20) @db.Decimal(5, 2)
  delai_validite_devis  Int      @default(30)
  delai_paiement        Int      @default(30)

  // Acompte par défaut
  acompte_pourcentage_defaut Decimal @default(30) @db.Decimal(5, 2)
  delai_paiement_acompte     Int     @default(7)

  // Mode de paiement par défaut
  mode_paiement_defaut  ModePaiement @default(VIREMENT)

  // Numérotation avec acronymes
  prefixe_devis              String   @default("DEV")
  prefixe_facture_finale     String   @default("FF")      // Facture Finale
  prefixe_facture_acompte    String   @default("FA")      // Facture Acompte

  prochain_numero_devis           Int  @default(1)
  prochain_numero_facture_finale  Int  @default(1)
  prochain_numero_facture_acompte Int  @default(1)

  conditions_generales  String?  @db.Text
  mentions_legales      String?  @db.Text

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("parametres")
}

// ============================================
// ENUMS
// ============================================

enum TypeTarification {
  FORFAIT
  FONCTIONNALITE
  TJM
  MIXTE
}

enum TypeLigne {
  FORFAIT
  FONCTIONNALITE
  TJM
  AUTRE
}

enum StatutDevis {
  BROUILLON
  ENVOYE
  ACCEPTE
  REFUSE
  EXPIRE
}

enum StatutFacture {
  EN_ATTENTE
  PAYEE
  PAYEE_PARTIELLEMENT
  EN_RETARD
  ANNULEE
}

enum TypeFacture {
  ACOMPTE
  FINALE
}

enum ModePaiement {
  VIREMENT    // Par défaut
  CHEQUE
  ESPECES
  CARTE_BANCAIRE
  PAYPAL
  STRIPE
  AUTRE
}
